apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: airlock-microgateway
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: microgateway-operator
    app.kubernetes.io/part-of: microgateway
    app.kubernetes.io/version: 4.7.4
    helm.sh/chart: microgateway-4.7.4
  name: airlock-microgateway-operator
  namespace: syn-airlock-microgateway
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/component: controller
      app.kubernetes.io/instance: airlock-microgateway
      app.kubernetes.io/name: microgateway-operator
  strategy:
    type: RollingUpdate
  template:
    metadata:
      annotations:
        checksum/config: 19f15250858adf8bbd9b7b173509d30286e893f0016b90364d19f7d526ebf06c
        kubectl.kubernetes.io/default-container: manager
      labels:
        app.kubernetes.io/component: controller
        app.kubernetes.io/instance: airlock-microgateway
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: microgateway-operator
        app.kubernetes.io/part-of: microgateway
        app.kubernetes.io/version: 4.7.4
        helm.sh/chart: microgateway-4.7.4
    spec:
      containers:
        - args:
            - --config=/app/config/operator_config.yaml
          env:
            - name: ENGINE_IMAGE
              value: quay.io/airlock/microgateway-engine@sha256:8de4c14273579b00420cc1d39086d1e4d079597a3842dd9436148f115c33cfd6
            - name: SESSION_AGENT_IMAGE
              value: quay.io/airlock/microgateway-session-agent@sha256:9cadfcf3554226116baccb06127fd2406f0438ea2ed65982989dfc9132bdbb2f
            - name: OPERATOR_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: OPERATOR_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: LOG_LEVEL
              value: info
            - name: SIDECAR_GATEWAY_ENABLED
              value: 'true'
            - name: SIDECAR_GATEWAY_POD_MONITOR_CREATE
              value: 'false'
            - name: GATEWAY_API_ENABLED
              value: 'true'
            - name: GATEWAY_API_CONTROLLER_NAME
              value: microgateway.airlock.com/gatewayclass-controller
            - name: GATEWAY_API_POD_MONITOR_CREATE
              value: 'true'
            - name: GATEWAY_API_POD_MONITOR_ADDITIONAL_LABELS
              value: release=kube-prometheus-stack
          image: quay.io/airlock/microgateway-operator@sha256:744ef9910c61a343b58cde5d021e1da4fc2cd087aaa8ffde0b0f72b1adae23b6
          imagePullPolicy: IfNotPresent
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8081
            initialDelaySeconds: 15
            periodSeconds: 20
            timeoutSeconds: 5
          name: manager
          ports:
            - containerPort: 9443
              name: webhook-server
              protocol: TCP
            - containerPort: 13377
              name: xds-server
              protocol: TCP
            - containerPort: 8080
              protocol: TCP
            - containerPort: 8081
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /readyz
              port: 8081
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
          resources:
            limits:
              cpu: 2500m
              memory: 512Mi
            requests:
              cpu: 250m
              memory: 512Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            seccompProfile:
              type: RuntimeDefault
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: FallbackToLogsOnError
          volumeMounts:
            - mountPath: /tmp/k8s-webhook-server/serving-certs
              name: cert
              readOnly: true
            - mountPath: /app/config/license/
              name: airlock-microgateway-license
              readOnly: true
            - mountPath: /app/config/operator_config.yaml
              name: operator-config
              subPath: operator_config.yaml
            - mountPath: /app/config/sidecar/engine_container_template.yaml
              name: operator-config
              subPath: engine_container_template.yaml
            - mountPath: /app/config/sidecar/network_validator_container_template.yaml
              name: operator-config
              subPath: network_validator_container_template.yaml
            - mountPath: /app/config/sidecar/session_agent_container_template.yaml
              name: operator-config
              subPath: session_agent_container_template.yaml
            - mountPath: /app/config/engine_bootstrap_config_template.yaml
              name: operator-config
              subPath: engine_bootstrap_config_template.yaml
      securityContext:
        runAsNonRoot: true
      serviceAccountName: airlock-microgateway-operator
      terminationGracePeriodSeconds: 10
      volumes:
        - name: cert
          secret:
            defaultMode: 420
            secretName: airlock-microgateway-operator-webhook-server-cert
        - name: airlock-microgateway-license
          secret:
            defaultMode: 292
            optional: true
            secretName: airlock-microgateway-license
        - configMap:
            name: airlock-microgateway-operator-config
          name: operator-config
