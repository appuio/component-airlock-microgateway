apiVersion: v1
kind: ServiceAccount
metadata:
  name: airlock-microgateway-upgrade-approval
  namespace: appuio-openshift-upgrade-controller
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: airlock-microgateway-upgrade-approval
  namespace: syn-airlock-microgateway
rules:
  - apiGroups:
      - operators.coreos.com
    resources:
      - installplans
    verbs:
      - get
      - list
      - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: airlock-microgateway-upgrade-approval
  namespace: syn-airlock-microgateway
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: airlock-microgateway-upgrade-approval
subjects:
  - kind: ServiceAccount
    name: airlock-microgateway-upgrade-approval
    namespace: appuio-openshift-upgrade-controller
---
apiVersion: v1
data:
  approve: |
    #!/bin/bash

    ONE_WEEK_AGO=$(date -v-${APPROVE_DELAY} -u +%Y-%m-%dT%H:%M:%SZ)
    INSTALLPLAN=$(kubectl -n syn-airlock-microgateway get ip -ojson | jq -r --arg date ${ONE_WEEK_AGO} '.items | sort_by(.metadata.creationTimestamp) | reverse | [.[] |  select((.spec.approved != true) and (.metadata.creationTimestamp < $date))][0] | .metadata.name')
    if [ ${INSTALLPLAN} != "null" ]; then
      kubectl patch installplan ${INSTALLPLAN} -n ${NAMESPACE} --type merge --patch '{"spec":{"approved":true}}';
    fi
kind: ConfigMap
metadata:
  name: airlock-microgateway-upgrade-approval
  namespace: appuio-openshift-upgrade-controller
---
apiVersion: managedupgrade.appuio.io/v1beta1
kind: UpgradeJobHook
metadata:
  name: airlock-microgateway-upgrade-approval
  namespace: appuio-openshift-upgrade-controller
spec:
  events:
    - Create
  selector:
    matchLabels:
      appuio-managed-upgrade: 'true'
  template:
    spec:
      template:
        spec:
          containers:
            - args: []
              command:
                - /usr/local/bin/approve
              env:
                - name: APPROVE_DELAY
                  value: 0d
                - name: NAMESPACE
                  value: syn-airlock-microgateway
              image: $(registry)s/$(image)s:$(tag)s
              imagePullPolicy: IfNotPresent
              name: approve
              ports: []
              stdin: false
              tty: false
              volumeMounts:
                - mountPath: /usr/local/bin/approve
                  name: scripts
                  readOnly: true
                  subPath: approve
          priorityClassName: system-cluster-critical
          restartPolicy: Never
          serviceAccountName: airlock-microgateway-upgrade-approval
          volumes:
            - configMap:
                defaultMode: 360
                name: airlock-microgateway-upgrade-approval
              name: scripts
